# ğŸ° Há»‡ thá»‘ng Quay sá»‘ TrÃºng thÆ°á»Ÿng (Lottery System)

Há»‡ thá»‘ng quay sá»‘ trÃºng thÆ°á»Ÿng vá»›i giao diá»‡n 3D hiá»‡n Ä‘áº¡i, há»— trá»£ quáº£n lÃ½ ngÆ°á»i dÃ¹ng, giáº£i thÆ°á»Ÿng vÃ  theo dÃµi káº¿t quáº£ quay sá»‘.

## ğŸ“‹ Má»¥c lá»¥c

- [TÃ­nh nÄƒng](#tÃ­nh-nÄƒng)
- [Cáº¥u trÃºc dá»± Ã¡n](#cáº¥u-trÃºc-dá»±-Ã¡n)
- [YÃªu cáº§u há»‡ thá»‘ng](#yÃªu-cáº§u-há»‡-thá»‘ng)
- [CÃ i Ä‘áº·t](#cÃ i-Ä‘áº·t)
- [CÃ¡ch sá»­ dá»¥ng](#cÃ¡ch-sá»­-dá»¥ng)
- [API Endpoints](#api-endpoints)
- [Cáº¥u hÃ¬nh](#cáº¥u-hÃ¬nh)
- [Docker](#docker)
- [LÆ°u Ã½](#lÆ°u-Ã½)

## âœ¨ TÃ­nh nÄƒng

- ğŸ² **Quay sá»‘ 3D**: Giao diá»‡n quay sá»‘ vá»›i hiá»‡u á»©ng 3D mÆ°á»£t mÃ 
- ğŸ‘¥ **Quáº£n lÃ½ ngÆ°á»i dÃ¹ng**: Import danh sÃ¡ch ngÆ°á»i tham gia tá»« file Excel
- ğŸ† **Quáº£n lÃ½ giáº£i thÆ°á»Ÿng**: ThÃªm, sá»­a, xÃ³a giáº£i thÆ°á»Ÿng vá»›i hÃ¬nh áº£nh
- ğŸ“Š **Theo dÃµi káº¿t quáº£**: Xem danh sÃ¡ch ngÆ°á»i trÃºng thÆ°á»Ÿng theo tá»«ng giáº£i
- ğŸ® **Äiá»u khiá»ƒn tá»« xa**: Äiá»u khiá»ƒn quay sá»‘ qua WebSocket
- ğŸ“¤ **Xuáº¥t káº¿t quáº£**: Xuáº¥t káº¿t quáº£ quay sá»‘ ra file Excel
- ğŸ’¾ **LÆ°u trá»¯ dá»¯ liá»‡u**: Tá»± Ä‘á»™ng lÆ°u dá»¯ liá»‡u vÃ o file, khÃ´ng máº¥t khi restart server

## ğŸ“ Cáº¥u trÃºc dá»± Ã¡n

```
lottery/
â”œâ”€â”€ server/                 # Backend server
â”‚   â”œâ”€â”€ server.js          # Main server file
â”‚   â”œâ”€â”€ index.js           # Entry point
â”‚   â”œâ”€â”€ config.js          # Cáº¥u hÃ¬nh giáº£i thÆ°á»Ÿng
â”‚   â”œâ”€â”€ help.js            # Utility functions
â”‚   â”œâ”€â”€ data/              # Dá»¯ liá»‡u
â”‚   â”‚   â””â”€â”€ users.xlsx     # File danh sÃ¡ch ngÆ°á»i tham gia
â”‚   â”œâ”€â”€ cache/             # Cache files
â”‚   â”‚   â”œâ”€â”€ temp.json      # Káº¿t quáº£ quay sá»‘
â”‚   â”‚   â”œâ”€â”€ error.json     # Danh sÃ¡ch ngÆ°á»i khÃ´ng Ä‘áº¿n
â”‚   â”‚   â””â”€â”€ prizes.json    # Cáº¥u hÃ¬nh giáº£i thÆ°á»Ÿng Ä‘Ã£ lÆ°u
â”‚   â””â”€â”€ uploads/           # ThÆ° má»¥c upload file
â”œâ”€â”€ product/               # Frontend
â”‚   â”œâ”€â”€ src/               # Source code
â”‚   â”‚   â”œâ”€â”€ index.html     # Trang quay sá»‘ chÃ­nh
â”‚   â”‚   â”œâ”€â”€ admin.html     # Trang quáº£n trá»‹
â”‚   â”‚   â”œâ”€â”€ controller.html # Trang Ä‘iá»u khiá»ƒn
â”‚   â”‚   â”œâ”€â”€ display.html   # Trang hiá»ƒn thá»‹ káº¿t quáº£
â”‚   â”‚   â””â”€â”€ lottery/       # Module quay sá»‘
â”‚   â””â”€â”€ dist/              # Build output
â”œâ”€â”€ Makefile               # Make commands
â”œâ”€â”€ docker-compose.yml     # Docker compose config
â”œâ”€â”€ Dockerfile             # Docker image config
â””â”€â”€ README.md              # File nÃ y
```

## ğŸ”§ YÃªu cáº§u há»‡ thá»‘ng

- **Node.js**: >= 12.x
- **npm** hoáº·c **pnpm**
- **Docker** (tÃ¹y chá»n, náº¿u cháº¡y báº±ng Docker)

## ğŸš€ CÃ i Ä‘áº·t

### CÃ i Ä‘áº·t dependencies

```bash
# CÃ i Ä‘áº·t cho cáº£ server vÃ  product
make install

# Hoáº·c cÃ i Ä‘áº·t riÃªng láº»
make install-server    # CÃ i Ä‘áº·t dependencies cho server
make install-product   # CÃ i Ä‘áº·t dependencies cho product
```

### CÃ i Ä‘áº·t thá»§ cÃ´ng

```bash
# CÃ i Ä‘áº·t server dependencies
cd server && npm install

# CÃ i Ä‘áº·t product dependencies
cd product && npm install
```

## ğŸ’» CÃ¡ch sá»­ dá»¥ng

### Development Mode

Cháº¡y á»Ÿ cháº¿ Ä‘á»™ development vá»›i hot-reload:

```bash
make dev
```

Hoáº·c:

```bash
cd product && npm run dev
```

- **Product dev server**: http://localhost:9000
- **Server backend**: http://localhost:18888

### Production Mode

Build vÃ  cháº¡y production:

```bash
make serve
```

Hoáº·c:

```bash
# Build
make build

# Cháº¡y server
cd product && npm run serve
```

Server sáº½ cháº¡y táº¡i: **http://localhost:8090** (hoáº·c port Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh)

### CÃ¡c lá»‡nh Make khÃ¡c

```bash
make help          # Xem danh sÃ¡ch lá»‡nh
make build          # Build product
make clean          # XÃ³a node_modules vÃ  dist
make clean-build    # Chá»‰ xÃ³a dist
make stop           # Dá»«ng táº¥t cáº£ process
make restart        # Dá»«ng vÃ  khá»Ÿi Ä‘á»™ng láº¡i dev mode
```

### Cháº¡y vá»›i port tÃ¹y chá»‰nh

```bash
# Server
node server/index.js 8090

# Product (sau khi build)
cd product/dist && node ../../server/index.js 8888
```

## ğŸ”Œ API Endpoints

### User Management

- `POST /api/uploadUsers` - Upload danh sÃ¡ch ngÆ°á»i tham gia (file Excel)
  - Body: `multipart/form-data` vá»›i field `file`
  - Response: `{ success: true, count: number }`

- `POST /getUsers` - Láº¥y danh sÃ¡ch táº¥t cáº£ ngÆ°á»i tham gia
  - Response: `Array<[mÃ£, há» tÃªn, phÃ²ng ban]>`

### Prize Management

- `POST /getPrizes` - Láº¥y danh sÃ¡ch giáº£i thÆ°á»Ÿng
  - Response: `{ prizes: Array, cfgData: { EACH_COUNT: Array } }`

- `POST /api/addPrize` - ThÃªm giáº£i thÆ°á»Ÿng má»›i
  - Body: `{ text, title, count, img }`
  - Response: `{ success: boolean }`

- `PUT /api/updatePrize/:type` - Cáº­p nháº­t giáº£i thÆ°á»Ÿng
  - Body: `{ text, title, count, img, perDraw? }`
  - Response: `{ success: boolean }`

- `DELETE /api/deletePrize/:type` - XÃ³a giáº£i thÆ°á»Ÿng
  - Response: `{ success: boolean }`

- `PUT /api/updatePrizePerDraw/:type` - Cáº­p nháº­t sá»‘ lÆ°á»£ng quay má»—i láº§n
  - Body: `{ perDraw: number }`
  - Response: `{ success: boolean }`

- `POST /api/uploadPrizeImg` - Upload hÃ¬nh áº£nh giáº£i thÆ°á»Ÿng
  - Body: `multipart/form-data` vá»›i field `file`
  - Response: `{ success: true, url: string }`

### Lottery Operations

- `POST /getTempData` - Láº¥y dá»¯ liá»‡u táº¡m (káº¿t quáº£ quay sá»‘, ngÆ°á»i cÃ²n láº¡i)
  - Response: `{ cfgData, leftUsers, luckyData }`

- `POST /saveData` - LÆ°u káº¿t quáº£ quay sá»‘
  - Body: `{ type: number, data: Array }`
  - Response: `{ type: string }`

- `POST /errorData` - LÆ°u danh sÃ¡ch ngÆ°á»i khÃ´ng Ä‘áº¿n
  - Body: `{ data: Array }`
  - Response: `{ type: string }`

- `POST /reset` - Reset táº¥t cáº£ dá»¯ liá»‡u quay sá»‘
  - Response: `{ type: "success" }`

### Statistics & Export

- `GET /api/stats` - Láº¥y thá»‘ng kÃª
  - Response: `{ totalUsers, luckyUsers, leftUsers, totalPrizes, drawnPrizes, remainingPrizes }`

- `GET /api/winners` - Láº¥y danh sÃ¡ch ngÆ°á»i trÃºng thÆ°á»Ÿng theo giáº£i
  - Response: `{ success: true, prizes: Array }`

- `POST /export` - Xuáº¥t káº¿t quáº£ ra file Excel
  - Response: `{ type: "success", url: "ket-qua-quay-so-so.xlsx" }`

## âš™ï¸ Cáº¥u hÃ¬nh

### Cáº¥u hÃ¬nh giáº£i thÆ°á»Ÿng

Chá»‰nh sá»­a file `server/config.js`:

```javascript
const prizes = [
  {
    type: 0,              // ID giáº£i (0 = giáº£i Ä‘áº·c biá»‡t)
    count: 1000,          // Sá»‘ lÆ°á»£ng giáº£i
    title: "",            // MÃ´ táº£
    text: "Giáº£i Ä‘áº·c biá»‡t", // TÃªn giáº£i
    img: ""               // ÄÆ°á»ng dáº«n hÃ¬nh áº£nh
  },
  // ... cÃ¡c giáº£i khÃ¡c
];

const EACH_COUNT = [1, 1, 5, 6, 7, 8, 9, 10]; // Sá»‘ lÆ°á»£ng quay má»—i láº§n
```

**LÆ°u Ã½**: 
- Giáº£i thÆ°á»Ÿng Ä‘Æ°á»£c lÆ°u tá»± Ä‘á»™ng vÃ o `server/cache/prizes.json` khi thÃªm/sá»­a/xÃ³a
- Cáº¥u hÃ¬nh máº·c Ä‘á»‹nh trong `config.js` chá»‰ dÃ¹ng khi chÆ°a cÃ³ file `prizes.json`

### File dá»¯ liá»‡u

- **Danh sÃ¡ch ngÆ°á»i tham gia**: `server/data/users.xlsx`
  - Format: Excel vá»›i header `[MÃ£ nhÃ¢n viÃªn, Há» tÃªn, PhÃ²ng ban]`
  - File nÃ y Ä‘Æ°á»£c tá»± Ä‘á»™ng cáº­p nháº­t khi import user má»›i

- **Káº¿t quáº£ quay sá»‘**: `server/cache/temp.json`
- **Danh sÃ¡ch ngÆ°á»i khÃ´ng Ä‘áº¿n**: `server/cache/error.json`
- **Cáº¥u hÃ¬nh giáº£i thÆ°á»Ÿng**: `server/cache/prizes.json`

## ğŸ³ Docker

### Build Docker image

```bash
./build.sh [tag]
```

### Cháº¡y vá»›i Docker

```bash
./dev.sh [tag]
```

### Docker Compose

```bash
docker-compose up -d
```

Server sáº½ cháº¡y táº¡i port **28458** (mapped tá»« 8888 trong container).

## ğŸ“ LÆ°u Ã½

### Import User

- Khi import user má»›i:
  - âœ… Dá»¯ liá»‡u cÅ© (káº¿t quáº£ quay sá»‘, danh sÃ¡ch ngÆ°á»i khÃ´ng Ä‘áº¿n) sáº½ bá»‹ **xÃ³a tá»± Ä‘á»™ng**
  - âœ… Danh sÃ¡ch user má»›i Ä‘Æ°á»£c **lÆ°u vÃ o file** `server/data/users.xlsx`
  - âœ… Dá»¯ liá»‡u Ä‘Æ°á»£c **xÃ¡o trá»™n** ngáº«u nhiÃªn

### Multi-tenant

- âš ï¸ Hiá»‡n táº¡i há»‡ thá»‘ng lÃ  **single-instance**, khÃ´ng há»— trá»£ nhiá»u cÃ´ng ty cÃ¹ng lÃºc
- Táº¥t cáº£ ngÆ°á»i dÃ¹ng dÃ¹ng chung má»™t bá»™ dá»¯ liá»‡u
- Náº¿u cáº§n há»— trá»£ multi-tenant, cáº§n thÃªm cÆ¡ cháº¿ phÃ¢n biá»‡t cÃ´ng ty (companyId, subdomain, v.v.)

### WebSocket

- Há»‡ thá»‘ng sá»­ dá»¥ng WebSocket Ä‘á»ƒ Ä‘á»“ng bá»™ giá»¯a cÃ¡c client
- Khi cÃ³ thay Ä‘á»•i giáº£i thÆ°á»Ÿng, táº¥t cáº£ client sáº½ Ä‘Æ°á»£c thÃ´ng bÃ¡o tá»± Ä‘á»™ng

### Port Conflicts

Náº¿u gáº·p lá»—i port Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng:

```bash
# TÃ¬m process Ä‘ang dÃ¹ng port
lsof -ti:8090

# Dá»«ng process
kill -9 $(lsof -ti:8090)
```

Hoáº·c dÃ¹ng lá»‡nh:

```bash
make stop
```

## ğŸ“„ License

Xem file [LICENSE](LICENSE) Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t.

## ğŸ‘¤ Author

moshang

## ğŸ”— Links

- Repository: https://github.com/moshang-xc/web-server

